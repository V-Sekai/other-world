# Proposed: VR Game with 80 Players and One World Server

## The Context

We aim to create a virtual reality (VR) game that can support eighty players simultaneously using a single world server.

## The Problem Statement

The challenge lies in managing the load of player simulations, world server, and game state delivery.

### Player Simulation Results

See `VSK_godot/modules/mvsqlite/demo`

### World Server

We are going with the grid approach. Our world is a 1km by 1km area and each grid cell is 100m squared.

Player servers need to regularly update the world server with the state of each player.

After the player simulation completes, the player server forwards the shallow player state to the world server 100 times per second.

A 1x1 grid of 100m squared requires only 1 world server.

The World Server goes to the player databases and selects, modifies, and inserts.

```gdscript
var id : int
var db := MVSQLite.new()

func _init():
    if !db.open("world_server.db"):
        print("Error: ", db.get_last_error_message())

func update_player_states(players):
    for player in players:
        var sql := "INSERT OR REPLACE INTO players (id, state) VALUES (?, ?)"
        var query = db.create_query(sql)
        query.execute([player.id, player.state])

        if query.get_last_error_message() != "":
            print("Error: ", query.get_last_error_message())

func get_player_states():
    var player_states = []
    var sql := "SELECT id, state FROM players"
    var query = db.create_query(sql)
    query.execute([])

    while query.step() == SQLiteQuery.BUSY:
        var player_state = {}
        player_state["id"] = query.get_column_text(0)
        player_state["state"] = query.get_column_blob(1)
        player_states.append(player_state)

    return player_states
```

```gdscript
var db := MVSQLite.new()
var query = null

func _init():
    if !db.open("world_server"):
        print("Error: ", db.get_last_error_message())
    else:
        prepare_query()

func prepare_query():
    var sql := "SELECT id, state FROM players"
    query = db.create_query(sql)

func get_player_states():
    if query == null:
        print("Error: Query not prepared")
        return []

    var results = query.execute([])

    var player_states = []
    for row in results:
        var player_state = {}
        player_state["id"] = row[0]
        player_state["state"] = row[1]
        player_states.append(player_state)

    return player_states
```

### World Database

Our player server is designed to accommodate up to 80 game players. These players are distributed across TBD CPUs. Each CPU is tasked with managing a total of TBD players.

To handle such a load, we run TBD processes per CPU. These processes block on some asynchronous calls out to the world server.

Our choice of database for this world is SQLite FoundationDB.

### Game State Delivery

The game state delivery process involves the world server generating a stream of data containing the states of all players. This data is then sent to the client-side for rendering and interaction.

This list can then be used to generate the TBD gigabit/sec stream of packets that is sent from the world server.

Please note that the limiting factor here is due to the lack of multicast support over the internet.

### State updates per second

| Server Type | Operation | Frequency | Transactions per Second                            | Server Inputs      | Server Outputs                  |
| ----------- | --------- | --------- | -------------------------------------------------- | ------------------ | ------------------------------- |
| Player      | Write     | 100 FPS   | 100 \* ( 1 + 80 ) writes/sec                       | 80 (from player)   | 1 (to world) + 80 (to database) |
| World       | Write     | 100 FPS   | 100 \* ( 1 ) writes/sec + 100 \_ 100 \* (1 ) reads | 80 (from database) | 1 (to player servers)           |

### State updates per second

| Server Type | Operation  | Frequency | Transactions per Second                          | Inputs                     | Outputs                         |
| ----------- | ---------- | --------- | ------------------------------------------------ | -------------------------- | ------------------------------- |
| Player      | Write      | 100 FPS   | 100 \* ( 1 + 80 ) writes/sec                     | 80 (from player)           | 1 (to world) + 80 (to database) |
| World       | Write      | 100 FPS   | 100 \* ( 1 ) writes/sec + 100 _ 100 _ (1 ) reads | 80 (from database)         | 1 (to player servers)           |
| Client      | Read/Write | 100 Hz    | Variable                                         | 1 (from the player server) | 1 (to the player server)        |

## The Benefits

- Supports a moderate number of players simultaneously
- Provides a rich, immersive gaming experience
- Simplified infrastructure with only one world server

## The Downsides

- Requires significant resources and infrastructure
- Bandwidth requirements may be high for some players
- Lack of multicast support over the internet could limit game state delivery

## The Road Not Taken

An alternative would be to increase the number of players or world servers, but this would require more resources and infrastructure.

## The Infrequent Use Case

In cases where player traffic is consistently low, the infrastructure may be underutilized.

## In Core and Done by Us

The proposed stress testing will be conducted by the V-Sekai development team.

## Status

Status: Proposed <!-- Draft | Proposed | Rejected | Accepted | Deprecated | Superseded by -->

## Decision Makers

- V-Sekai development team

## Tags

- V-Sekai

## Further Reading

1. [V-Sekai Â· GitHub](https://github.com/v-sekai) - Official GitHub account for the V-Sekai development community focusing on social VR functionality for the Godot Engine.
2. [V-Sekai/v-sekai-game](https://github.com/v-sekai/v-sekai-game) is the GitHub page for the V-Sekai open-source project, which brings social VR/VRSNS/metaverse components to the Godot Engine.
3. [creating-a-first-person-shooter-that-scales-to-millions-of-players](https://mas-bandwidth.com/creating-a-first-person-shooter-that-scales-to-millions-of-players)

AI assistant Aria assisted with this article.
