import { getWorldPosition } from "../GLTF/index.js";

export class Skeleton {
  constructor(gltf) {
    const humanBones = new Map();
    for (const { bone, node } of gltf.extensions.VRM.humanoid.humanBones)
      humanBones.set(bone, gltf.nodes[node]);

    this.bones = BoneNames.map((name) =>
      humanBones.get(name.slice(0, 1).toLowerCase() + name.slice(1))
    );
    this.humanScale = getWorldPosition(this.bones[0])[1];
    this.parents = this.parents.map((p) => {
      while (p >= 0 && !this.bones[p]) p = this.parents[p];
      return p;
    });
  }
}
export const BoneNames = [
  "Hips",
  "LeftUpperLeg",
  "RightUpperLeg",
  "LeftLowerLeg",
  "RightLowerLeg",
  "LeftFoot",
  "RightFoot",
  "Spine",
  "Chest",
  "Neck",
  "Head",
  "LeftShoulder",
  "RightShoulder",
  "LeftUpperArm",
  "RightUpperArm",
  "LeftLowerArm",
  "RightLowerArm",
  "LeftHand",
  "RightHand",
  "LeftToes",
  "RightToes",
  "LeftEye",
  "RightEye",
  "Jaw",
  "LeftThumbProximal",
  "LeftThumbIntermediate",
  "LeftThumbDistal",
  "LeftIndexProximal",
  "LeftIndexIntermediate",
  "LeftIndexDistal",
  "LeftMiddleProximal",
  "LeftMiddleIntermediate",
  "LeftMiddleDistal",
  "LeftRingProximal",
  "LeftRingIntermediate",
  "LeftRingDistal",
  "LeftLittleProximal",
  "LeftLittleIntermediate",
  "LeftLittleDistal",
  "RightThumbProximal",
  "RightThumbIntermediate",
  "RightThumbDistal",
  "RightIndexProximal",
  "RightIndexIntermediate",
  "RightIndexDistal",
  "RightMiddleProximal",
  "RightMiddleIntermediate",
  "RightMiddleDistal",
  "RightRingProximal",
  "RightRingIntermediate",
  "RightRingDistal",
  "RightLittleProximal",
  "RightLittleIntermediate",
  "RightLittleDistal",
  "UpperChest",
];
Skeleton.prototype.parents = [
  -1, 0, 0, 1, 2, 3, 4, 0, 7, 54, 9, 54, 54, 11, 12, 13, 14, 15, 16, 5, 6, 10,
  10, 10, 17, 24, 25, 17, 27, 28, 17, 30, 31, 17, 33, 34, 17, 36, 37, 18, 39,
  40, 18, 42, 43, 18, 45, 46, 18, 48, 49, 18, 51, 52, 8,
];
Skeleton.prototype.axes = [
  [
    [+0.0, +0.0, +0.0, +1.0],
    [+0.0, +0.0, +0.0, +1.0],
    [+1, +1, +1],
  ], // Hips
  [
    [-0.62644, +0.34855, -0.59144, +0.36918],
    [-0.50952, +0.48977, -0.48105, +0.51876],
    [+1, +1, +1],
  ], // LeftUpperLeg
  [
    [-0.59144, +0.36918, -0.62644, +0.34855],
    [-0.48105, +0.51876, -0.50952, +0.48977],
    [-1, -1, +1],
  ], // RightUpperLeg
  [
    [-0.04422, +0.69691, -0.04313, +0.7145],
    [-0.49312, +0.50616, -0.48097, +0.51894],
    [+1, -1, -1],
  ], // LeftLowerLeg
  [
    [-0.04313, +0.7145, -0.04422, +0.69691],
    [-0.48097, +0.51894, -0.49312, +0.50616],
    [-1, +1, -1],
  ], // RightLowerLeg
  [
    [-0.5, +0.5, -0.5, +0.5],
    [-0.5, +0.5, -0.5, +0.5],
    [+1, +1, +1],
  ], // LeftFoot
  [
    [-0.5, +0.5, -0.5, +0.5],
    [-0.5, +0.5, -0.5, +0.5],
    [-1, -1, +1],
  ], // RightFoot
  [
    [+0.46815, +0.52994, -0.46815, -0.52994],
    [+0.46815, +0.52994, -0.46815, -0.52994],
    [+1, +1, +1],
  ], // Spine
  [
    [+0.52661, +0.47189, -0.52661, -0.47189],
    [+0.52661, +0.47189, -0.52661, -0.47189],
    [+1, +1, +1],
  ], // Chest
  [
    [+0.46642, +0.5316, -0.46748, -0.5304],
    [+0.46642, +0.5316, -0.46748, -0.5304],
    [+1, +1, +1],
  ], // Neck
  [
    [-0.5, -0.5, +0.5, +0.5],
    [-0.5, -0.5, +0.5, +0.5],
    [+1, +1, +1],
  ], // Head
  [
    [+0.03047, +0.00261, +0.9959, -0.08517],
    [+0.03047, +0.00261, +0.9959, -0.08517],
    [+1, +1, -1],
  ], // LeftShoulder
  [
    [-0.00261, -0.03047, -0.08518, +0.9959],
    [-0.00261, -0.03047, -0.08518, +0.9959],
    [-1, +1, +1],
  ], // RightShoulder
  [
    [+0.24793, -0.0042, +0.90224, -0.35282],
    [+0.00419, +0.0001, +0.99972, -0.02326],
    [+1, +1, -1],
  ], // LeftUpperArm
  [
    [+0.0042, -0.24793, -0.35282, +0.90224],
    [-0.0001, -0.00419, -0.02326, +0.99972],
    [-1, +1, +1],
  ], // RightUpperArm
  [
    [+0.47584, +0.52201, +0.52305, -0.47697],
    [+0.02834, +0.70648, +0.70654, -0.02988],
    [+1, +1, -1],
  ], // LeftLowerArm
  [
    [-0.52202, -0.47584, -0.47697, +0.52305],
    [-0.70648, -0.02834, -0.02988, +0.70654],
    [-1, +1, +1],
  ], // RightLowerArm
  [
    [+0.04117, +0.00004, +0.99915, -0.00109],
    [+0.04117, +0.00004, +0.99915, -0.00109],
    [+1, +1, -1],
  ], // LeftHand
  [
    [-0.00004, -0.04117, -0.00109, +0.99915],
    [-0.00004, -0.04117, -0.00109, +0.99915],
    [-1, +1, +1],
  ], // RightHand
  [
    [+0.70711, +0.0, +0.70711, +0.0],
    [+0.70711, +0.0, +0.70711, +0.0],
    [+1, +1, +1],
  ], // LeftToes
  [
    [+0.70711, +0.0, +0.70711, +0.0],
    [+0.70711, +0.0, +0.70711, +0.0],
    [-1, -1, +1],
  ], // RightToes
  [
    [+0.70711, +0.0, +0.70711, +0.0],
    [+0.70711, +0.0, +0.70711, +0.0],
    [-1, +1, -1],
  ], // LeftEye
  [
    [+0.70711, +0.0, +0.70711, +0.0],
    [+0.70711, +0.0, +0.70711, +0.0],
    [+1, -1, -1],
  ], // RightEye
  [
    [0, 0, 0, 1],
    [0, 0, 0, 1],
    [1, 1, 1],
  ], // Jaw
  [
    [+0.25516, +0.62821, +0.5807, -0.4506],
    [+0.25711, +0.64267, +0.65871, -0.29491],
    [+1, -1, +1],
  ], // LeftThumbProximal
  [
    [+0.09906, +0.69392, +0.70013, -0.1359],
    [+0.23444, +0.6538, +0.66711, -0.26935],
    [+1, -1, +1],
  ], // LeftThumbIntermediate
  [
    [+0.09906, +0.69392, +0.70013, -0.1359],
    [+0.23444, +0.6538, +0.66711, -0.26935],
    [+1, -1, +1],
  ], // LeftThumbDistal
  [
    [+0.15036, +0.02227, +0.94561, -0.2876],
    [+0.07773, +0.00016, +0.99697, -0.00204],
    [-1, -1, -1],
  ], // LeftIndexProximal
  [
    [+0.05321, +0.01854, +0.94281, -0.32854],
    [+0.05634, +0.00093, +0.99827, -0.01654],
    [-1, -1, -1],
  ], // LeftIndexIntermediate
  [
    [+0.05321, +0.01854, +0.94281, -0.32854],
    [+0.05634, +0.00093, +0.99827, -0.01654],
    [-1, -1, -1],
  ], // LeftIndexDistal
  [
    [+0.06963, +0.00934, +0.94994, -0.30443],
    [+0.03295, +0.0006, +0.99929, -0.01826],
    [-1, -1, -1],
  ], // LeftMiddleProximal
  [
    [+0.01913, +0.00746, +0.93156, -0.363],
    [+0.02051, +0.00108, +0.99839, -0.05279],
    [-1, -1, -1],
  ], // LeftMiddleIntermediate
  [
    [+0.01913, +0.00746, +0.93156, -0.363],
    [+0.02051, +0.00108, +0.99839, -0.05279],
    [-1, -1, -1],
  ], // LeftMiddleDistal
  [
    [-0.03589, +0.00104, +0.95494, -0.29463],
    [+0.00251, +0.00002, +0.99997, -0.00784],
    [+1, +1, -1],
  ], // LeftRingProximal
  [
    [+0.006, +0.00186, +0.955, -0.29653],
    [+0.00628, -0.00011, +0.99982, +0.01768],
    [+1, +1, -1],
  ], // LeftRingIntermediate
  [
    [+0.006, +0.00186, +0.955, -0.29653],
    [+0.00628, -0.00011, +0.99982, +0.01768],
    [+1, +1, -1],
  ], // LeftRingDistal
  [
    [-0.07607, +0.00044, +0.9538, -0.29066],
    [+0.00035, +0.0, +0.99999, -0.00435],
    [+1, +1, -1],
  ], // LeftLittleProximal
  [
    [-0.02491, -0.0077, +0.95502, -0.29538],
    [-0.02607, +0.00049, +0.99948, +0.01878],
    [+1, +1, -1],
  ], // LeftLittleIntermediate
  [
    [-0.02491, -0.0077, +0.95502, -0.29538],
    [-0.02607, +0.00049, +0.99948, +0.01878],
    [+1, +1, -1],
  ], // LeftLittleDistal
  [
    [+0.62827, +0.2554, +0.45053, -0.58057],
    [-0.6427, -0.25738, -0.29486, +0.6586],
    [-1, -1, -1],
  ], // RightThumbProximal
  [
    [+0.69394, +0.0993, +0.13583, -0.7001],
    [-0.65382, -0.23468, -0.26929, +0.66703],
    [-1, -1, -1],
  ], // RightThumbIntermediate
  [
    [+0.69394, +0.0993, +0.13583, -0.7001],
    [-0.65382, -0.23468, -0.26929, +0.66703],
    [-1, -1, -1],
  ], // RightThumbDistal
  [
    [+0.02227, +0.15036, +0.28761, -0.94561],
    [-0.00016, -0.07773, -0.00204, +0.99697],
    [+1, -1, +1],
  ], // RightIndexProximal
  [
    [+0.01854, +0.0532, +0.32854, -0.94281],
    [-0.00093, -0.05633, -0.01654, +0.99827],
    [+1, -1, +1],
  ], // RightIndexIntermediate
  [
    [+0.01854, +0.0532, +0.32854, -0.94281],
    [-0.00093, -0.05633, -0.01654, +0.99827],
    [+1, -1, +1],
  ], // RightIndexDistal
  [
    [+0.00934, +0.06962, +0.30443, -0.94994],
    [-0.0006, -0.03295, -0.01826, +0.99929],
    [+1, -1, +1],
  ], // RightMiddleProximal
  [
    [+0.00746, +0.01913, +0.36299, -0.93157],
    [-0.00108, -0.0205, -0.05278, +0.9984],
    [+1, -1, +1],
  ], // RightMiddleIntermediate
  [
    [+0.00746, +0.01913, +0.36299, -0.93157],
    [-0.00108, -0.0205, -0.05278, +0.9984],
    [+1, -1, +1],
  ], // RightMiddleDistal
  [
    [+0.00104, -0.03589, +0.29463, -0.95494],
    [-0.00002, -0.00251, -0.00784, +0.99997],
    [-1, +1, +1],
  ], // RightRingProximal
  [
    [+0.00186, +0.00599, +0.29654, -0.955],
    [+0.00011, -0.00627, +0.01767, +0.99982],
    [-1, +1, +1],
  ], // RightRingIntermediate
  [
    [+0.00186, +0.00599, +0.29654, -0.955],
    [+0.00011, -0.00627, +0.01767, +0.99982],
    [-1, +1, +1],
  ], // RightRingDistal
  [
    [+0.00044, -0.07606, +0.29066, -0.9538],
    [-0.0, -0.00036, -0.00435, +0.99999],
    [-1, +1, +1],
  ], // RightLittleProximal
  [
    [-0.0077, -0.0249, +0.29537, -0.95503],
    [-0.00049, +0.02606, +0.01879, +0.99948],
    [-1, +1, +1],
  ], // RightLittleIntermediate
  [
    [-0.0077, -0.0249, +0.29537, -0.95503],
    [-0.00049, +0.02606, +0.01879, +0.99948],
    [-1, +1, +1],
  ], // RightLittleDistal
  [
    [+0.56563, +0.42434, -0.56563, -0.42434],
    [+0.56563, +0.42434, -0.56563, -0.42434],
    [+1, +1, +1],
  ], // UpperChest
].map(([preQ, postQ, sign]) => ({
  preQ: Float32Array.from(preQ),
  postQ: Float32Array.from(postQ),
  sign: Float32Array.from(sign),
}));
